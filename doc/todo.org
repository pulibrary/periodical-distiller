# -*- lexical-binding: t; -*-
#+TITLE: TODOs for Princeton Distiller

* Ad Hoc TODOs
** TODO [#C] Consider adding lxml type stubs
:PROPERTIES:
:CUSTOM_ID: add-lxml-type-stubs
:ASSIGNEES: Claude
:END:

- Motivation :: In [[file:~/repos/gh/pulibrary/periodical-distiller/src/schemas/article.py][article.py]], basedpyright complains that =_Element= is
not known.
- Suggested Action :: Add type hints for lxml using [[https://github.com/lxml/lxml-stubs/blob/master/lxml-stubs/etree.pyi][lxml-stubs]].
** DONE Create Pydantic schema for CEO3 Items
CLOSED: [2026-01-30]
:PROPERTIES:
:ASSIGNEES: Claude
:CUSTOM_ID: create-pydantic-schema-for-ceoitems
:COMMIT: 18d986d
:END:

- Motivation :: The CEOClient needs this schema to validate data it
  fetches; other components will use it to access record fields.

*** References
- [[https://docs.getsnworks.com/ceo2/front-end/json-api.html][CEO FrontEnd JSON API]]

** DONE Fix bug: API request fails with a 403 error                    :BUG:
CLOSED: [2026-01-30]
:PROPERTIES:
:ASSIGNEES: Claude
:CUSTOM_ID: API-request-fails
:COMMIT: 99e6967
:END:

#+begin_src bash
  pdm run python -m periodical_distiller.cli harvest-pip --date 2026-01-15
  INFO: Fetching articles for 2026-01-15
  INFO: HTTP Request: GET https://www.dailyprincetonian.com/api/content/v1/content?limit=100&offset=0&start_date=2026-01-15&end_date=2026-01-15 "HTTP/1.1 403 Forbidden"
  ERROR: Failed to create PIP: API error 403: https://www.dailyprincetonian.com/api/content/v1/content?limit=100&offset=0&start_date=2026-01-15&end_date=2026-01-15
#+end_src
** DONE Fix bug: media requests fail with 404                          :BUG:
CLOSED: [2026-01-31]
:PROPERTIES:
:ASSIGNEES: Claude
:CUSTOM_ID: media-request-fails
:END:
- Root cause :: Incorrect imgix CDN URL format. Was using
  ~{attachment_uuid}/{base_name}.{extension}~ but the correct format is
  ~pri/{attachment_uuid}.sized-1000x1000.{extension}~.
#+begin_src bash
  pdm run python -m periodical_distiller.cli harvest-pip --date 2026-01-29
  INFO: Fetching articles for 2026-01-29
  INFO: HTTP Request: GET https://www.dailyprincetonian.com/section/news.json?page=1&perPage=100 "HTTP/1.1 200 OK"
  INFO: HTTP Request: GET https://snworksceo.imgix.net/f1b219da-32c6-4256-9536-4d94f3b39289/annie-rupertus-spia-plaza-spring-2.jpg "HTTP/1.1 404 Not Found"
  WARNING: Failed to download media for article 73628: HTTP 404
  INFO: HTTP Request: GET https://snworksceo.imgix.net/075988f6-5052-4285-8512-c49c4209bbfb/img-2413.jpg "HTTP/1.1 404 Not Found"
  WARNING: Failed to download media for article 73623: HTTP 404
  INFO: Created PIP 2026-01-29 with 2 articles at workspace/pips/2026-01-29
  INFO: Created PIP: 2026-01-29
  INFO:   Title: The Daily Princetonian - January 29, 2026
  INFO:   Articles: 2
  INFO:   Output: workspace/pips/2026-01-29
#+end_src
** DONE Fix bug: Flourish redirects and HEIC media downloads            :BUG:
CLOSED: [2026-01-31]
:PROPERTIES:
:ASSIGNEES: Claude
:CUSTOM_ID: media-request-fails-again
:END:
- Symptoms ::
  1. Flourish chart thumbnails failed with HTTP 302 (redirect not followed)
  2. HEIC media files failed with HTTP 404

- Root causes and fixes ::
  1. *Flourish 302*: httpx client wasn't configured to follow redirects.
     Fixed by adding ~follow_redirects=True~ to the httpx.Client constructor.
  2. *HEIC 404*: imgix stores HEIC files as PNG, not with original extension.
     Fixed by adding fallback URL logic that tries multiple extensions
     (jpg, png) when the primary URL returns 404.

- Changes ::
  - ~MediaDownloader._get_client()~: Added ~follow_redirects=True~
  - ~MediaDownloader._build_media_urls()~: New method returning list of
    fallback URLs for HEIC files (sized jpg, sized png, unsized jpg, unsized png)
  - ~MediaDownloader._download_dominant_media()~: Now tries fallback URLs
    when primary returns 404

*** Original bug report
1. Code isn't following 302 redirect.  For example,
   #+begin_example
       INFO: HTTP Request: GET https://public.flourish.studio/visualisation/26729538/thumbnail "HTTP/1.1 302 Found"
       WARNING: Failed to download Flourish chart 26729538 for article 73431: HTTP 302
   #+end_example

   https://public.flourish.studio/visualisation/26729538/thumbnail resolves to https://public.flourish.studio/published_thumbnails/visualisation/26729538/04d5600837812eaa.jpg

2. Not handling media with .heic extension.  For example,
   #+begin_example
       INFO: HTTP Request: GET https://snworksceo.imgix.net/pri/1348d282-34ee-4cae-a78c-d4ae7c0f8e12.sized-1000x1000.heic "HTTP/1.1 404 Not Found"
       WARNING: Failed to download media for article 73405: HTTP 404
   #+end_example

   Adding ?fm=jpg extension still causes a 404:

   #+begin_example
     INFO: HTTP Request: GET https://snworksceo.imgix.net/pri/1348d282-34ee-4cae-a78c-d4ae7c0f8e12.sized-1000x1000.heic?fm=jpg "HTTP/1.1 404 Not Found"
     WARNING: Failed to download media for article 73405: HTTP 404
   #+end_example
** DONE Fix bug: output from HTML transformer does not include dominant media :BUG:
CLOSED: [2026-02-02]
:PROPERTIES:
:CUSTOM_ID: html-transformer-output-does-not-include-dominant-media
:ASSIGNEES: Claude
:END:
The CEO record includes a "dominantMedia" property that provides metadata about a block of content that
should appear below the headline and before the byline. Here is an example:

#+begin_example
    "dominantMedia": {
      "id": "19166",
      "uuid": "4ef275d7-a74b-4ae3-8d1e-3e49e904d274",
      "attachment_uuid": "075988f6-5052-4285-8512-c49c4209bbfb",
      "base_name": "img-2413",
      "extension": "jpg",
      "preview_extension": "jpg",
      "title": "marquand library photo",
      "content": "<h5>View of campus from the third floor of Marquand Library. </h5><h6>Leela Hensler / The Daily Princetonian</h6>",
      "source": null,
      "click_through": null,
      "type": "image",
      "height": null,
      "width": null,
      "seo_title": null,
      "seo_description": null,
      "seo_image": null,
      "svg_preview": null,
      "status": "0",
      "weight": "0",
      "hits": "0",
      "transcoded": "0",
      "created_at": "2026-01-29 01:26:14",
      "modified_at": "2026-01-29 01:28:11",
      "published_at": null,
      "normalized_tags": "||",
      "ceo_id": "73626",
      "ssts_id": null,
      "ssts_path": null,
      "metadata": [
        {
          "label": "author_ordered",
          "value": "[]"
        }
      ],
      "authors": []
    }
#+end_example

Note that in this example the "type" is "image" -- we will need to do
research to see if there are other types of DominantMedia.  For now,
filter on type and only process images.

Note also the "content" property: it contains a caption (<h5>View of
campus from the third floor of Marquand Library. </h5>) and a credit line
(<h6>Leela Hensler / The Daily Princetonian</h6>).  This content
should be transformed into semantic divs (<div class="caption"> and
<div class="credit">, and the CSS stylesheet should be modified to
handle them.
** TODO [#C] Research: what are the forms of Dominant Media for articles?
:PROPERTIES:
:CUSTOM_ID: what-are-types-of-dominant-media
:ASSIGNEES: Claude, Cliff
:END:
A small sampling shows one format -- "type":"image" -- but there may
be others.

Download a sampling of CEO records and gather values from the
dominantMedia["type"] property; put these in a report called
"dominant-media-types.org".
** DONE [#A] PDFTransformer.transform signature doesn't match base class
CLOSED: [2026-02-02]
:PROPERTIES:
:CUSTOM_ID: pdftransformer.transform-signature-does-not-match
:ASSIGNEES: Claude
:END:
The base Transformer class takes a pip_path as an argument but
PDFTransformer.transform does not, because the PDFTransformer class
doesn't need it. This causes basedpyright to complain.  Explain the
right fix before implementing it.

- Resolution :: Split Transformer into two base classes:
  - ~PIPTransformer~: PIP→SIP transformers (e.g., HTMLTransformer)
  - ~SIPTransformer~: SIP→SIP enrichment (e.g., PDFTransformer)
  - ~Transformer~ kept as alias for backwards compatibility
** DONE [#A] Fix bug: error trying to load image file
CLOSED: [2026-02-19]
:PROPERTIES:
:CUSTOM_ID: run_pipeline.error-loading-image-file
:ASSIGNEES: Claude
:END:
- Root cause :: Relative ~sip_path~ produced a malformed ~file://hostname/path~
  URL for ~base_url~ in ~PDFTransformer._transform_article~.  WeasyPrint
  stripped the hostname, yielding a path that didn't exist.
- Fix :: Replace ~f"file://{article_dir}/"~ with
  ~article_dir.resolve().as_uri() + "/"~.  ~Path.resolve()~ converts to an
  absolute path; ~Path.as_uri()~ always emits the correct three-slash form.
Example of failure:
#+begin_src sh
  ➜  periodical-distiller git:(main) pdm run python -m periodical_distiller.cli run-pipeline --pip workspace/pips/2026-01-01_to_2026-01-14
  INFO: Seeded token 2026-01-01_to_2026-01-14 to pip_harvested
  INFO: Transforming PIP 2026-01-01_to_2026-01-14 with 3 articles
  INFO: Created SIP 2026-01-01_to_2026-01-14 with 3 articles
  INFO: Transforming SIP 2026-01-01_to_2026-01-14 with 3 articles to PDF
  ERROR: Failed to load stylesheet at file://workspace/sips/2026-01-01_to_2026-01-14/article.css: URLError: <urlopen error [Errno 2] No such file or directory: '/sips/2026-01-01_to_2026-01-14/article.css'>
  ERROR: Failed to load image at 'file://workspace/sips/2026-01-01_to_2026-01-14/articles/73553/images/nassau-street-and-tigertransit-bus-mc-mccoy-4-15-25.jpg': URLError: <urlopen error [Errno 2] No such file or directory: '/sips/2026-01-01_to_2026-01-14/articles/73553/images/nassau-street-and-tigertransit-bus-mc-mccoy-4-15-25.jpg'>
  ERROR: Failed to load stylesheet at file://workspace/sips/2026-01-01_to_2026-01-14/article.css: URLError: <urlopen error [Errno 2] No such file or directory: '/sips/2026-01-01_to_2026-01-14/article.css'>
  ERROR: Failed to load image at 'file://workspace/sips/2026-01-01_to_2026-01-14/articles/73542/images/dan-weiner-hhr-7x5.png': URLError: <urlopen error [Errno 2] No such file or directory: '/sips/2026-01-01_to_2026-01-14/articles/73542/images/dan-weiner-hhr-7x5.png'>
  ERROR: Failed to load stylesheet at file://workspace/sips/2026-01-01_to_2026-01-14/article.css: URLError: <urlopen error [Errno 2] No such file or directory: '/sips/2026-01-01_to_2026-01-14/article.css'>
  ERROR: Failed to load image at 'file://workspace/sips/2026-01-01_to_2026-01-14/articles/73539/images/walk-near-nassau-st-fall-gheorghita-10-25-24.jpg': URLError: <urlopen error [Errno 2] No such file or directory: '/sips/2026-01-01_to_2026-01-14/articles/73539/images/walk-near-nassau-st-fall-gheorghita-10-25-24.jpg'>
  INFO: PDF transformation complete for SIP 2026-01-01_to_2026-01-14
  INFO: Transforming SIP 2026-01-01_to_2026-01-14 with 3 articles to ALTO
  INFO: ALTO transformation complete for SIP 2026-01-01_to_2026-01-14
  INFO: Transforming SIP 2026-01-01_to_2026-01-14 with 3 articles to MODS
  INFO: MODS transformation complete for SIP 2026-01-01_to_2026-01-14
  INFO: Transforming SIP 2026-01-01_to_2026-01-14 with 3 articles to JPEG images
  INFO: Image transformation complete for SIP 2026-01-01_to_2026-01-14
  INFO: Compiling Veridian SIP at workspace/sips/2026-01-01_to_2026-01-14
  INFO: Compiling METS for SIP 2026-01-01_to_2026-01-14
  INFO: Wrote METS to workspace/sips/2026-01-01_to_2026-01-14/mets.xml
  INFO: SIP 2026-01-01_to_2026-01-14 sealed with METS at mets.xml
  INFO: Pipeline complete for 2026-01-01_to_2026-01-14
  INFO:   Status: sealed
  INFO:   METS: mets.xml
  INFO:   Output: workspace/sips/2026-01-01_to_2026-01-14
#+end_src
** DONE [#A] Fix bug: error trying to load stylesheet file
CLOSED: [2026-02-19]
:PROPERTIES:
:CUSTOM_ID: run_pipeline.error-loading-stylesheet-file
:ASSIGNEES: Claude
:END:
- Root cause :: Same as ~run_pipeline.error-loading-image-file~ — same malformed
  ~base_url~ causes WeasyPrint to fail resolving the stylesheet referenced in the
  HTML ~<link>~ tag.
- Fix :: See ~run_pipeline.error-loading-image-file~.
Example of failure:
#+begin_src sh
  ➜  periodical-distiller git:(main) pdm run python -m periodical_distiller.cli run-pipeline --pip workspace/pips/2026-01-01_to_2026-01-14
  INFO: Seeded token 2026-01-01_to_2026-01-14 to pip_harvested
  INFO: Transforming PIP 2026-01-01_to_2026-01-14 with 3 articles
  INFO: Created SIP 2026-01-01_to_2026-01-14 with 3 articles
  INFO: Transforming SIP 2026-01-01_to_2026-01-14 with 3 articles to PDF
  ERROR: Failed to load stylesheet at file://workspace/sips/2026-01-01_to_2026-01-14/article.css: URLError: <urlopen error [Errno 2] No such file or directory: '/sips/2026-01-01_to_2026-01-14/article.css'>
  ERROR: Failed to load image at 'file://workspace/sips/2026-01-01_to_2026-01-14/articles/73553/images/nassau-street-and-tigertransit-bus-mc-mccoy-4-15-25.jpg': URLError: <urlopen error [Errno 2] No such file or directory: '/sips/2026-01-01_to_2026-01-14/articles/73553/images/nassau-street-and-tigertransit-bus-mc-mccoy-4-15-25.jpg'>
  ERROR: Failed to load stylesheet at file://workspace/sips/2026-01-01_to_2026-01-14/article.css: URLError: <urlopen error [Errno 2] No such file or directory: '/sips/2026-01-01_to_2026-01-14/article.css'>
  ERROR: Failed to load image at 'file://workspace/sips/2026-01-01_to_2026-01-14/articles/73542/images/dan-weiner-hhr-7x5.png': URLError: <urlopen error [Errno 2] No such file or directory: '/sips/2026-01-01_to_2026-01-14/articles/73542/images/dan-weiner-hhr-7x5.png'>
  ERROR: Failed to load stylesheet at file://workspace/sips/2026-01-01_to_2026-01-14/article.css: URLError: <urlopen error [Errno 2] No such file or directory: '/sips/2026-01-01_to_2026-01-14/article.css'>
  ERROR: Failed to load image at 'file://workspace/sips/2026-01-01_to_2026-01-14/articles/73539/images/walk-near-nassau-st-fall-gheorghita-10-25-24.jpg': URLError: <urlopen error [Errno 2] No such file or directory: '/sips/2026-01-01_to_2026-01-14/articles/73539/images/walk-near-nassau-st-fall-gheorghita-10-25-24.jpg'>
  INFO: PDF transformation complete for SIP 2026-01-01_to_2026-01-14
  INFO: Transforming SIP 2026-01-01_to_2026-01-14 with 3 articles to ALTO
  INFO: ALTO transformation complete for SIP 2026-01-01_to_2026-01-14
  INFO: Transforming SIP 2026-01-01_to_2026-01-14 with 3 articles to MODS
  INFO: MODS transformation complete for SIP 2026-01-01_to_2026-01-14
  INFO: Transforming SIP 2026-01-01_to_2026-01-14 with 3 articles to JPEG images
  INFO: Image transformation complete for SIP 2026-01-01_to_2026-01-14
  INFO: Compiling Veridian SIP at workspace/sips/2026-01-01_to_2026-01-14
  INFO: Compiling METS for SIP 2026-01-01_to_2026-01-14
  INFO: Wrote METS to workspace/sips/2026-01-01_to_2026-01-14/mets.xml
  INFO: SIP 2026-01-01_to_2026-01-14 sealed with METS at mets.xml
  INFO: Pipeline complete for 2026-01-01_to_2026-01-14
  INFO:   Status: sealed
  INFO:   METS: mets.xml
  INFO:   Output: workspace/sips/2026-01-01_to_2026-01-14
#+end_src
